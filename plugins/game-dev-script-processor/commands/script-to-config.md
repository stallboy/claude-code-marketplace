---
name: script-to-config
allowed_tools: mcp__cfg_mcp
description: 剧本到配置文件转换命令 - 通过剧本生成游戏配置文件
model: opus
---

# 剧本到配置文件转换命令

## 初始响应

当此命令被调用时：

1. **设置工作目录**：
   - 如果提供了剧本目录路径，则在当前目录下查找或者创建.work目录，设定为工作目录
   - 如果未提供，请求用户提供必要参数

2. **参数验证**：
   - 立即开始处理流程
   - 验证所有必需的目录和文件

3. **如果没有提供参数**，响应：
```
我将帮您将剧本文件转换为游戏配置文件。

请提供：
1. 剧本目录路径（必需）
2. 工作目录路径（可选，默认为.work）
3. 规则目录路径（可选，默认为在剧本目录下自动查找rule_*.md）

或者使用参数：
/script-to-config --script-dir Doc/剧本_md_dir --rule-dir Main/AIWork --work-dir .work
```

## 命令功能

### 核心功能
- 设定专用工作目录进行所有处理操作
- 读取指定目录下的转换规则文件
- 使用script-format-analyzer.md子代理分析剧本格式和结构 (仅当用户指定--analysis时才做此操作)
- 使用script-chunk-processor.md子代理将剧本文件分块并创建子目录
- 使用file-transformer.md子代理对每个分块文件进行转换
- 使用config-validator.md子代理进行最终验证

### 参数支持
- `--script-dir`: 剧本目录路径（必需）
- `--rule-dir`: 规则目录路径（可选）
- `--work-dir`: 工作目录路径（可选，默认为.work）
- `--analysis`: 开始处理签是否需要解析剧本格式（可选）
- `--chunk-size`: 分块大小配置（可选，默认10000）

## 工作流程

### 阶段1：初始化和参数验证

#### 执行步骤：
1. **验证参数**：检查提供的目录路径是否存在
2. **设置工作目录**：进入指定的工作目录（非剧本文件目录）, 如果该目录为.work目录且非空且没有指定resume参数，则**清空该目录**
3. **查找转换规则文件**：在剧本目录中查找转换规则文件
4. **分析剧本**：扫描剧本目录，识别所有剧本文件 (不要读取文件内容， 剧本文件为所有不以rule_为前缀的md文件)

#### 成功标准：
- [ ] 工作目录成功设置,如果目录为.work确保该目录清空
- [ ] 所有参数验证通过
- [ ] 转换规则文件成功找到
- [ ] 剧本文件列表生成

**实施说明**：完成此阶段后，显示剧本分析结果、找到的转换规则文件和计划处理的分块数量。

---

### 阶段2：剧本格式分析(可跳过)

该阶段仅当用户指定了--analysis参数时才执行，**否则直接跳过**

#### 执行步骤：
1. **启动格式分析器**：在工作目录下使用`script-format-analyzer`代理分析剧本目录
2. **格式分析**：分析剧本文件的结构、元素类型和格式特征
3. **生成格式说明**：创建详细的格式说明文档（format-specification.md, 放置在工作目录下）
4. **分析结果应用**：将格式分析结果传递给后续处理阶段

#### 格式分析内容：
- **结构识别**：识别章节、场景、对话、选项、QTE等元素
- **格式特征**：分析缩进风格、标记符号、分隔规则
- **模式总结**：总结线性、分支、循环等结构模式
- **文档生成**：生成标准化的格式说明文档

#### 子代理调用 - script-format-analyzer.md：
```
输入参数：
- 剧本目录路径
- 工作目录路径
- 输出目录路径（默认为剧本目录）

输出：
- format-specification.md（格式说明文档）
- 分析报告和统计信息
```

#### 成功标准：
- [ ] 格式说明文档生成
- [ ] 后续处理代理可读取格式说明

**实施说明**：完成此阶段后，显示格式分析结果、识别的元素类型和生成的格式说明文档位置。如果已存在有效的格式说明文档且剧本未修改，可跳过此阶段。

---

### 阶段3：剧本分块子目录创建和分块处理

#### 执行步骤：
1. **创建子目录结构**：为每个剧本文件创建独立的子目录
2. **启动分块处理器**：在工作目录下使用`script-chunk-processor`代理, **只传递必要参数，子代理会自行决断如何处理，如果有规则文件就不要提任何额外要求**
3. **分块处理**：将每个剧本文件按章节分割并保存到对应子目录

#### 子代理调用 - script-chunk-processor.md：
```
输入参数：
- 剧本文件路径
- 工作目录路径
- 分块大小配置（可选但不建议）
- 输出子目录规则
- 剧本结构分析结果（如果执行了分析阶段提供，否则不提供）

输出：
- 每个剧本文件对应的子目录
- 分块后的文件列表
```

#### 成功标准：
- [ ] 所有剧本文件成功分块
- [ ] 每个分块文件保存在对应的子目录中
- [ ] 子目录结构清晰

**实施说明**：完成此阶段后，显示分块处理结果、生成的子目录结构和分块文件统计。你可以根据子代理的回报将分块文件生成列表文件存储于工作目录中，并在后续的转换过程中在该文件中标记完成情况。

---

### 阶段4：文件转换处理

#### 执行步骤：
1. **确认转换规则文件目录**：在剧本目录中查找转换规则文件,确认转换规则，回显给用户
2. **逐个处理分块文件(调用file-transformer子代理)**：对每个子目录中的分块文件进行转换
3. **收集转换结果**：保存每个文件的转换结果和状态更新

#### 转换流程：
1. **遍历子目录**：按顺序访问每个剧本文件的子目录
2. **处理分块文件**：对子目录中的每个分块文件调用转换

#### 子代理调用 - file-transformer.md：
```
输入参数：
- 分块文件路径
- 转换规则文件路径(设置转换规则根目录为Main/AIWork目录)
- 附加规则（如有）

输出：
- 处理报告
```

#### 成功标准：
- [ ] 所有分块文件成功转换
- [ ] 转换规则正确应用
- [ ] 输出文件结构正确

**实施说明**：完成此阶段后，显示文件转换结果、生成的配置文件统计。

---

### 阶段5：配置验证

#### 执行步骤：
1. **启动验证器**：在工作目录下使用`config-validator`代理
2. **语法验证**：检查配置文件语法正确性
3. **逻辑验证**：验证游戏逻辑的一致性
4. **完整性验证**：检查配置数据的完整性

#### 验证内容：
- **视频配置**：video.cfg文件的正确性
- **故事配置**：story.cfg文件的分支逻辑
- **道具配置**：prop.cfg文件的连贯性
- **角色配置**：role.cfg文件的完整性

#### 子代理调用 - config-validator.md：
```
输入参数：
- 转换后的配置文件目录
- 编码偏移信息
- 验证规则文件（如有）

输出：
- 验证报告
- 发现的问题列表
- 修复建议
- 最大编码号
```

#### 成功标准：
- [ ] 所有配置文件语法正确
- [ ] 游戏逻辑验证通过
- [ ] 配置完整性检查通过
- [ ] 编码一致性验证通过
- [ ] 验证报告生成完成

**实施说明**：完成此阶段后，显示验证结果、发现的问题和最终的编码状态。

---

### 阶段6：最终交付

#### 执行步骤：
1. **文件组织**：整理所有生成的文件
2. **文档生成**：创建配置说明文档
3. **清理工作**：清理临时文件和中间结果
4. **总结报告**：生成处理总结报告

#### 交付内容：
- **配置文件**：所有生成的.cfg和JSON文件
- **文档文件**：配置说明和使用指南
- **处理报告**：详细的处理统计和结果
- **备份文件**：重要文件的备份副本

#### 成功标准：
- [ ] 所有文件正确组织
- [ ] 文档完整清晰
- [ ] 临时文件清理完成
- [ ] 总结报告生成

**实施说明**：完成此阶段后，显示最终交付结果和文件位置。

## 错误处理

### 错误分类
- **可恢复错误**：临时问题，可以重试
- **配置错误**：规则或配置问题，需要调整
- **系统错误**：环境问题，需要人工干预

### 错误恢复
- **自动重试**：对临时错误进行有限次重试
- **跳过处理**：标记无法处理的内容继续其他部分
- **降级处理**：使用简化规则处理复杂内容

## 使用示例

### 基本使用
```bash
/script-to-config --script-dir Doc/剧本_md_dir --work-dir Main/AIWork
```

### 完整参数
```bash
/script-to-config --script-dir Doc/剧本_md_dir --work-dir Main/AIWork --output-dir Main/AIWork/output --rule-dir Config/rules
```

### 继续上次处理
```bash
/script-to-config --script-dir Doc/剧本_md_dir --work-dir Main/AIWork --resume
```

### 自定义分块大小
```bash
/script-to-config --script-dir Doc/剧本_md_dir --work-dir Main/AIWork --chunk-size 150
```

## 子代理系统

### 使用的专业代理
- `script-format-analyzer` - 剧本格式分析专家
- `script-chunk-processor` - 剧本分块处理专家
- `file-transformer` - 文件转换专家
- `config-validator` - 配置验证专家

### 代理协调
- 主命令协调所有子代理工作
- 确保上下文信息的有效传递

## 重要指南

### 1. 完整性优先
- 确保所有剧本内容都被处理
- 验证生成配置的完整性
- 保持处理过程的连续性

### 2. 交互式工作
- 在每个关键阶段显示进度
- 及时报告发现的问题
- 根据用户反馈调整处理

### 3. 质量保证
- 严格验证配置的正确性
- 确保游戏逻辑的一致性
- 测试所有可能的游戏路径

### 4. 文档化
- 记录所有处理决策
- 创建完整的配置说明
- 提供问题排查指南

## 常见模式

### 对于新剧本处理
- 从剧本分析开始
- 分块处理所有内容
- 生成完整配置
- 验证配置质量

### 对于增量更新
- 分析变更部分
- 只处理受影响的分块
- 增量更新配置
- 回归验证

## 示例交互流程

```
用户: /script-to-config --script-dir Doc/剧本_md_dir --work-dir Main/AIWork
助理: 开始处理剧本到配置转换流程

[阶段1] 设置工作目录: .work
查找转换规则文件: rule_trans_*.md
找到2个转换规则文件: rule_trans_1.md, rule_trans_item.md
发现7个剧本文件，总计6573行。

[阶段2] 启动剧本格式分析器...
分析剧本文件格式和结构
识别元素类型: 章节、场景、对话、选项、QTE、道具、角色
生成格式说明文档: format-specification.md
格式分析完成，识别的结构模式: 线性叙事、分支选择

[阶段3] 启动剧本分块处理器...
基于格式分析结果进行智能分块
创建子目录结构:
- .work/剧本第一章_001.md.chunk/
- .work/剧本第二章_002.md.chunk/
- .work/剧本第三章_003.md.chunk/
- ...

分块处理完成，生成35个分块文件

[阶段4] 开始文件转换处理...
根据格式说明映射元素到配置文件
处理 .work/剧本第一章_001.md.chunk/chunk_01.md
调用 file-transformer 子代理
转换成功, 最大编码15

处理 .work/剧本第一章_001.md.chunk/chunk_02.md
调用 file-transformer 子代理
转换成功，最大编码: 23

[处理中] 正在处理分块 20/35 (57%完成)
累计生成: video.cfg(8), story.cfg(12), prop.cfg(5)

[阶段5] 配置验证...
收集所有转换后的回报
调用 config_validator 子代理
验证结果: 语法正确，逻辑完整，编码一致

[阶段6完成] 处理完成！
输出目录: Main/AIWork/_video_video
生成文件: 25个配置文件
最终编码状态: 1356
```

---

**注意**：此命令专门设计用于处理大型剧本文件，通过分块处理和子代理协调，确保在有限的上下文内高效完成复杂的配置生成任务。

**注意**：请假设用户的运行环境中没有任何编程语言的编译器和解释器，你只能使用系统默认工具和子代理和ClaudeCode提供的工具来工作，不允许自己编码执行脚本（如python和js）