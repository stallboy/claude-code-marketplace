# 默认剧本转换规则

## 概述

默认转换规则定义了如何将剧本内容转换为游戏配置文件的映射关系和模板。这些规则为剧本处理器提供了标准的转换指南。

## 规则文件位置

### 规则文件约定
- **项目级规则**: 从剧本自身所在目录读取 `rule.md` 文件
- **剧本级规则**: 支持剧本特定的规则文件
- **默认规则**: 当前文件作为默认规则定义

### 规则优先级
1. 剧本特定规则（最高优先级）
2. 项目级规则
3. 默认规则（最低优先级）

## 转换映射

### 剧本元素到配置文件的映射

```markdown
# 转换映射表

## 主要映射
- 对话 → video.cfg
- 选项 → story.cfg
- 道具 → prop.cfg
- 角色 → role.cfg
- QTE → qte.cfg
- 场景 → sceneexplore.cfg
- 成就 → achievement.cfg

## 辅助映射
- 角色关系 → role.cfg
- 场景描述 → sceneexplore.cfg
- 时间设置 → video.cfg
- 地点设置 → sceneexplore.cfg
```

### 详细映射说明

#### 对话处理
- **输入**: 角色对话内容
- **输出**: video.cfg 中的视频节点
- **模板**: 对话视频节点模板
- **验证**: 对话完整性检查

#### 选项处理
- **输入**: 玩家选择选项
- **输出**: story.cfg 中的分支逻辑
- **模板**: 选项分支模板
- **验证**: 选项可达性检查

#### 道具处理
- **输入**: 道具获取和使用
- **输出**: prop.cfg 中的道具定义
- **模板**: 道具配置模板
- **验证**: 道具连贯性检查

#### 角色处理
- **输入**: 角色介绍和关系
- **输出**: role.cfg 中的角色配置
- **模板**: 角色属性模板
- **验证**: 角色完整性检查

## 模板定义

### 视频配置模板 (video.cfg)

```markdown
# 视频节点模板

## 基本结构
- 节点ID: [自动生成]
- 视频文件: [根据场景生成]
- 下一话ID: [根据分支逻辑]
- 选择项: [选项配置]

## 对话节点示例
```
[node_1001]
type = dialogue
video_file = scene_1_dialogue_1.mp4
next_node = 1002
character = 林凡
dialogue_text = "这节课女生打今天打排球，大家先自己拉伸两分钟一下，跑跑步。"
```

## 选项节点示例
```
[node_1002]
type = choice
video_file = scene_1_choice_1.mp4
choices = 1003,1004,1005
choice_text_1003 = "帮助温苒拉伸"
choice_text_1004 = "帮助林雅"
choice_text_1005 = "我最亮眼"
```
```

### 故事配置模板 (story.cfg)

```markdown
# 故事配置模板

## 章节结构
- 章节ID: [自动编号]
- 章节名称: [从剧本提取]
- 起始话数: [话数范围]
- 结束话数: [话数范围]

## 分支逻辑
- 分支点ID: [选项节点ID]
- 选择项: [选项配置]
- 目标话数: [下一话ID]
- 条件判断: [道具或状态条件]

## 示例配置
```
[chapter_1]
name = "女校？社团？"
start_node = 1001
end_node = 1050

[branch_1002]
choice_1003 = 1006  # 帮助温苒拉伸 → 场景2
choice_1004 = 1007  # 帮助林雅 → 场景3
choice_1005 = 1008  # 我最亮眼 → 场景4
```
```

### 道具配置模板 (prop.cfg)

```markdown
# 道具配置模板

## 道具定义
- 道具ID: [自动生成]
- 道具名称: [从剧本提取]
- 道具描述: [详细描述]
- 获取条件: [获取场景和条件]
- 使用效果: [使用后的影响]

## 示例配置
```
[prop_001]
name = "温苒的棒棒糖"
description = "温苒亲手制作的棒棒糖，第一个吃到的男生"
acquire_condition = "在烘焙社选择帮助温苒"
use_effect = "提升温苒好感度"

[prop_002]
name = "林雅的发卡"
description = "林雅翻墙时掉落的发卡"
acquire_condition = "在哭墙成功帮助林雅翻墙"
use_effect = "解锁林雅特殊剧情"
```
```

### 角色配置模板 (role.cfg)

```markdown
# 角色配置模板

## 角色属性
- 角色ID: [自动生成]
- 角色名称: [从剧本提取]
- 角色描述: [背景介绍]
- 初始好感度: [默认值]
- 特殊能力: [角色特性]

## 角色关系
- 关系对象: [其他角色ID]
- 关系类型: [友好/敌对/中立]
- 关系值: [数值表示]

## 示例配置
```
[role_001]
name = "林凡"
description = "华大唯一的男生，性格开朗"
initial_affection = 50
special_ability = "社交达人"

[role_002]
name = "温苒"
description = "班干部，温柔体贴的女生"
initial_affection = 60
special_ability = "烘焙高手"

[relation_001]
character_a = 001
character_b = 002
relation_type = "friendly"
relation_value = 70
```
```

## 验证规则和约束

### 语法验证
- **配置文件格式**: 必须符合游戏引擎要求的格式
- **字段完整性**: 所有必需字段必须存在
- **数据类型**: 字段值必须符合预期数据类型

### 逻辑验证
- **分支完整性**: 所有选择都必须有对应的目标
- **道具连贯性**: 道具获取和使用必须逻辑连贯
- **角色一致性**: 角色属性和关系必须一致

### 完整性验证
- **引用有效性**: 所有引用ID必须存在
- **配置完整性**: 所有必要的配置都必须生成
- **数据完整性**: 没有缺失的关键数据

## 特殊处理规则

### 复杂场景处理

#### 多角色对话
- 识别对话中的多个角色
- 为每个角色生成独立的对话节点
- 建立角色间的对话关系

#### 分支选项
- 识别选项条件和结果
- 建立完整的分支逻辑链
- 验证所有分支的可达性

#### 道具系统
- 跟踪道具的获取和使用
- 建立道具的状态变化
- 验证道具逻辑的连贯性

### 错误处理规则

#### 格式错误
- **症状**: 剧本格式不符合预期
- **处理**: 尝试标准化格式或标记为需要人工检查

#### 逻辑错误
- **症状**: 分支逻辑不完整或矛盾
- **处理**: 标记问题并提供修复建议

#### 数据缺失
- **症状**: 关键信息缺失
- **处理**: 使用默认值或标记为需要补充

## 自定义规则支持

### 规则扩展
- **添加新映射**: 支持新的剧本元素到配置的映射
- **修改模板**: 可以调整现有模板的结构
- **添加验证**: 支持新的验证规则

### 规则继承
- **基础规则**: 默认规则作为基础
- **项目规则**: 项目特定规则覆盖默认规则
- **剧本规则**: 剧本特定规则具有最高优先级

## 使用示例

### 基本转换示例

**输入剧本片段**:
```
林凡：这节课女生打今天打排球，大家先自己拉伸两分钟一下，跑跑步。
林凡举手：老师，那男生干嘛？
体育老师看着他，抓了抓头，拿过一个篮球给他。
体育老师：自己一边玩去，别影响女同学。
林凡：……
```

**生成配置**:
- video.cfg: 创建对话节点
- role.cfg: 添加林凡和体育老师角色
- story.cfg: 建立场景流程

### 选项转换示例

**输入剧本片段**:
```
选项2：帮助温苒拉伸
选项3：帮助林雅
选项4：我最亮眼
```

**生成配置**:
- story.cfg: 创建分支选择
- video.cfg: 生成选项节点
- prop.cfg: 可能关联道具获取

## 最佳实践

### 转换质量
1. **准确性**: 确保转换结果准确反映剧本内容
2. **完整性**: 确保所有剧本元素都被正确处理
3. **一致性**: 保持配置格式和逻辑的一致性
4. **可维护性**: 生成的配置易于理解和维护

### 性能考虑
1. **处理效率**: 优化转换算法的效率
2. **内存使用**: 控制处理过程中的内存使用
3. **输出优化**: 生成简洁高效的配置文件

---

**注意**: 默认转换规则为剧本处理器提供了基础指导。在实际使用中，可以根据具体项目的需求进行调整和扩展，以确保生成配置的质量和适用性。