# 进度跟踪规则

## 概述

进度跟踪规则定义了剧本处理过程中的状态管理和恢复机制。它确保大型剧本文件的处理可以安全中断并在之后继续，同时保持数据的完整性和一致性。

## 进度文件格式

### 标准进度文件结构

**文件位置**: `.claude/plugins/game-dev-script-processor/progress/{处理ID}.md`

```markdown
# 剧本处理进度跟踪

## 元数据
- 插件版本: 1.0.0
- 创建时间: 2025-11-20T10:30:00Z
- 最后更新: 2025-11-20T11:45:00Z
- 处理ID: proc_20251120_001

## 剧本信息
- 剧本文件: 剧本 第一章0124.md
- 文件路径: Doc/剧本_md_dir/剧本 第一章0124.md
- 总行数: 871
- 文件大小: 39KB

## 分块策略
- 策略类型: 按章节分割
- 总分块数: 5
- 分块大小限制: 200行
- 重叠行数: 10行

## 处理状态
- 当前分块: 3
- 已完成分块: 2
- 失败分块: 0
- 待处理分块: 3
- 完成百分比: 40.0%

## 中间结果

### 分块1 (已完成)
- 分块ID: chunk_1
- 状态: 已完成
- 结果文件: intermediate/chunk_1_result.md
- 生成配置: video.cfg, story.cfg
- 处理时间: 00:01:30
- 处理行数: 180

### 分块2 (已完成)
- 分块ID: chunk_2
- 状态: 已完成
- 结果文件: intermediate/chunk_2_result.md
- 生成配置: prop.cfg, role.cfg
- 处理时间: 00:02:15
- 处理行数: 195

## 错误日志

### 分块3错误
- 分块ID: chunk_3
- 错误类型: 解析错误
- 错误信息: 无法解析第245行的选项格式
- 时间戳: 2025-11-20T11:30:00Z
- 重试次数: 1

## 性能指标
- 总处理时间: 00:03:45
- 平均分块时间: 00:01:52
- 内存使用峰值: 128MB
- 磁盘使用: 2.1MB

## 恢复信息
- 可恢复: 是
- 恢复起始分块: 3
- 恢复条件:
  - 中间结果文件存在
  - 规则配置未变更
  - 剧本文件未修改
```

## 进度文件位置

### 标准路径约定
- **进度文件**: `.claude/plugins/game-dev-script-processor/progress/{处理ID}.md`
- **中间结果**: `.claude/plugins/game-dev-script-processor/intermediate/{分块ID}_result.md`
- **错误日志**: `.claude/plugins/game-dev-script-processor/logs/errors.md`

### 文件命名规则
- 进度文件: `progress_剧本名称_时间戳.md`
- 中间结果: `intermediate_分块ID_result.md`
- 错误日志: `errors_处理ID.md`

## 恢复机制

### 恢复条件检查
在尝试恢复处理之前，必须验证以下条件：

1. **文件完整性**
   - 进度文件存在且可读
   - 所有引用的中间结果文件存在
   - 剧本文件未被修改

2. **环境一致性**
   - 规则配置未变更
   - 插件版本兼容
   - 系统资源可用

3. **状态有效性**
   - 进度数据格式正确
   - 没有损坏的中间结果
   - 错误日志可解析

### 恢复流程

1. **加载进度文件** - 读取进度文件内容
2. **验证恢复条件** - 检查所有恢复条件是否满足
3. **恢复处理状态** - 获取当前分块和中间结果
4. **继续处理** - 从断点处继续处理

### 恢复策略

#### 完全恢复
- 从断点处继续处理
- 重用所有有效的中间结果
- 保持处理状态和统计信息

#### 部分恢复
- 跳过有问题的分块
- 重新处理损坏的中间结果
- 合并有效的处理结果

#### 安全恢复
- 创建恢复备份
- 验证每个步骤的结果
- 提供回滚机制

## 状态管理

### 状态转换流程
1. **初始化** → 开始处理
2. **分块中** → 正在分割剧本
3. **处理中** → 正在处理分块
4. **完成** → 分块处理完成
5. **错误** → 处理遇到错误
6. **暂停** → 处理被暂停
7. **验证中** → 正在验证结果
8. **已验证** → 验证完成

### 状态持久化
- **定期保存**: 每完成一个分块后保存进度
- **关键点保存**: 在重要决策点保存状态
- **错误时保存**: 发生错误时立即保存当前状态
- **手动保存**: 支持用户手动触发保存

## 错误处理

### 错误分类

#### 可恢复错误
- 临时文件访问问题
- 网络连接中断
- 内存不足警告
- 处理超时

#### 不可恢复错误
- 剧本文件损坏
- 规则配置错误
- 系统资源耗尽
- 插件版本不兼容

### 错误恢复策略

#### 自动重试
- 对临时错误进行重试
- 使用指数退避策略
- 记录重试次数和结果

#### 跳过处理
- 标记无法处理的分块
- 继续处理其他分块
- 在最终报告中汇总跳过信息

#### 降级处理
- 使用简化规则处理复杂分块
- 生成部分配置结果
- 标记需要人工干预的部分

### 性能优化
- **增量保存**: 只保存变更的状态
- **压缩存储**: 优化存储格式
- **缓存优化**: 缓存常用规则和模板
- **并行处理**: 支持多个分块并行处理

## 使用示例

### 创建进度跟踪

**步骤**:
1. 创建进度文件目录
2. 初始化进度文件内容
3. 设置初始处理状态
4. 保存进度文件

### 更新进度状态

**步骤**:
1. 读取当前进度文件
2. 更新处理状态信息
3. 添加中间结果记录
4. 更新完成百分比
5. 保存更新后的进度文件

## 最佳实践

1. **频繁保存**: 每完成一个重要步骤就保存进度
2. **验证完整性**: 在恢复前验证所有依赖文件的完整性
3. **提供反馈**: 向用户清晰显示处理进度和状态
4. **错误容忍**: 设计健壮的错误处理和恢复机制
5. **性能监控**: 持续监控性能指标并优化

## 故障排除

### 常见问题
- **进度文件损坏**: 提供进度文件修复工具
- **中间结果丢失**: 实现中间结果重建机制
- **版本不兼容**: 提供版本迁移工具
- **资源不足**: 实现资源监控和预警

### 调试信息
- 启用详细的进度日志
- 保存性能统计信息
- 提供状态诊断工具
- 实现进度可视化

---

**注意**: 进度跟踪是确保大型剧本处理可靠性的关键组件。务必仔细设计状态管理和恢复机制，确保在各种异常情况下都能保持数据的一致性和完整性。