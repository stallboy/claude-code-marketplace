# 上下文管理规则

## 概述

上下文管理规则定义了在处理大型剧本文件时的上下文优化策略。它确保在处理过程中有效管理上下文使用，避免上下文过大问题，同时保留关键信息以支持连续处理。

## 上下文压缩策略

### 保留信息（必须保留）

#### 规则配置信息
- 当前使用的转换规则
- 规则文件路径和版本
- 模板定义和映射关系
- 验证规则和约束条件

#### 处理状态信息
- 当前处理的分块ID
- 已完成的分块列表
- 处理进度和统计信息
- 错误计数和重试状态

#### 关键配置信息
- 剧本结构元数据
- 角色和道具映射表
- 场景和章节信息
- 分支逻辑关键点

#### 系统状态信息
- 插件版本信息
- 处理开始时间
- 性能指标基准

### 移除信息（可以压缩或移除）

#### 历史工作细节
- 已完成的详细处理步骤
- 临时变量和中间计算
- 调试信息和详细日志
- 重复的配置模板内容

#### 临时处理数据
- 处理过程中的临时变量
- 中间计算结果缓存
- 未使用的备选方案
- 调试用的测试数据

#### 冗余信息
- 重复的角色描述
- 相同的场景设置
- 类似的对话模式
- 重复的道具定义

### 摘要信息（压缩为摘要）

#### 处理进度摘要
- 已完成分块数量（而非详细列表）
- 总体完成百分比
- 关键里程碑达成情况
- 主要问题统计

#### 关键决策点
- 重要的分支选择
- 主要角色关系变化
- 关键道具获取事件
- 重要场景转换

## 子代理通信

### 最小必要信息传递

#### 分块处理请求
```markdown
# 分块处理请求

## 基本信息
- 分块ID: chunk_3
- 剧本文件: 剧本 第一章0124.md
- 起始行: 376
- 结束行: 575

## 规则配置
- 规则文件: scripts/rules/default-rule.md
- 转换映射: 对话→video.cfg, 选项→story.cfg
- 模板版本: v1.2

## 上下文信息
- 前一分块结果: intermediate/chunk_2_result.md
- 当前角色状态: 温苒(友好), 林雅(中立)
- 可用道具: 温苒的棒棒糖, 林雅的发卡
```

#### 处理结果返回
```markdown
# 分块处理结果

## 处理状态
- 分块ID: chunk_3
- 状态: 已完成
- 处理时间: 00:02:15
- 处理行数: 200

## 生成配置
- video.cfg: 新增3个视频节点
- story.cfg: 新增2个分支选择
- prop.cfg: 新增1个道具获取

## 关键信息
- 新角色: nico
- 新场景: 探险社招新处
- 重要事件: 成立探险社

## 错误和警告
- 警告: 第420行选项格式不规范
- 建议: 检查道具使用条件
```

### 结构化数据格式

#### 状态传递格式
```markdown
# 处理状态传递

## 核心状态
- 当前分块: 3/5
- 完成百分比: 60%

## 关键上下文
- 活跃角色: 林凡, 温苒, 林雅, nico
- 当前场景: 601号公寓
- 重要道具: 探险小说, 尼魅的假发

## 规则摘要
- 使用规则: default-rule v1.2
- 模板数量: 8个
- 验证通过: 是
```

#### 错误信息格式
```markdown
# 错误信息传递

## 错误详情
- 错误类型: 解析错误
- 分块ID: chunk_3
- 错误位置: 第245行
- 错误描述: 无法识别选项格式

## 上下文信息
- 前文内容: "林凡: 要不我帮你揉揉肩吧..."
- 错误行内容: "选项21: (需道具应援糖果)糖果"
- 建议修复: 标准化选项格式

## 恢复建议
- 重试次数: 1/3
- 跳过选项: 是
- 人工检查: 建议
```

## 上下文优化策略

### 限制单个块的处理复杂度

#### 分块大小控制
- **标准分块**: 150-200行剧本内容
- **复杂分块**: 包含多个场景或角色对话
- **简单分块**: 单一场景或连续对话
- **调整策略**: 根据内容复杂度动态调整

#### 复杂度评估
- **低复杂度**: 单一角色对话
- **中复杂度**: 多角色对话+简单选项
- **高复杂度**: 多角色+分支选项+QTE+道具
- **处理优先级**: 先处理低复杂度分块

### 使用外部存储保存中间结果

#### 中间结果存储
- **配置文件片段**: 保存为独立文件
- **处理状态**: 定期保存到进度文件
- **错误日志**: 单独的错误记录文件
- **性能数据**: 统计信息文件

#### 存储优化
- **压缩格式**: 使用简洁的Markdown格式
- **增量更新**: 只保存变更部分
- **版本控制**: 保留重要版本的历史
- **清理策略**: 定期清理临时文件

### 定期清理临时数据

#### 清理时机
- 分块处理完成后
- 错误恢复成功后
- 用户手动触发时

#### 清理内容
- 处理过程中的临时变量
- 未使用的缓存数据
- 过时的调试信息
- 重复的配置模板

## 优化策略

### 主动优化
- **预处理压缩**: 在处理前压缩不必要信息
- **动态调整**: 根据实际情况调整保留策略
- **优先级管理**: 重要信息优先保留

### 被动优化
- **自动清理**: 定期清理过期数据
- **错误恢复**: 错误时自动优化上下文
- **用户干预**: 支持手动优化控制

## 最佳实践

### 上下文管理原则

1. **必要性原则**: 只保留处理必需的信息
2. **简洁性原则**: 使用最简洁的表达方式
3. **一致性原则**: 保持上下文格式的一致性
4. **可恢复原则**: 确保中断后可以恢复处理

### 具体实施建议

#### 信息保留策略
- **核心规则**: 完整保留当前处理规则
- **关键状态**: 保留处理进度和重要决策
- **必要上下文**: 保留角色关系和道具状态
- **性能数据**: 保留基准性能指标

#### 信息压缩策略
- **详细日志**: 压缩为摘要统计
- **历史记录**: 只保留关键里程碑
- **重复内容**: 使用引用而非重复
- **临时数据**: 及时清理和压缩

### 处理效率优化

#### 并行处理
- 支持多个分块并行处理
- 合理分配处理任务
- 协调子代理工作流程

#### 缓存优化
- 缓存常用规则和模板
- 复用已验证的配置片段
- 优化重复内容的处理

#### 预处理策略
- 提前分析和优化处理策略
- 识别复杂内容提前准备
- 建立处理优先级队列

---

**注意**: 上下文管理是处理大型剧本文件的关键技术。通过精心设计的压缩策略和优化算法，可以在有限的上下文空间内高效处理复杂的剧本内容，同时确保处理的连续性和可靠性。